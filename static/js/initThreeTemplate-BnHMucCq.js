import{S as X,I as v,i as D,h as T,l as u,E as Y,G as Z,H as $,B as J,J as U}from"./main-BacqxwQj.js";import{aj as _,an as y,ao as K,ap as Q,aq as ee,ar as te,as as ie,at as se,au as ae,a0 as ne,av as H,W as oe,aw as re,h as B,ax as le,ay as he,i as de,j as A,az as W,ah as F,aB as L,aK as j,aM as O,aN as ce,C as p,aO as me,aP as I,aQ as pe,aR as ue,aL as ge,S as fe,aS as we,aT as Le,aA as Ce,M as G,aC as C,_ as be,V as N,T as b,X as Me,c as V,$ as z,F as q,L as M,aD as xe,aE as Se,ae as R,aF as Pe,aG as ye,aH as He,aI as Ae,g as Fe,aJ as ze,f as Re,D as ve,af as Ee,ag as ke,ai as De,ak as Te,aZ as Be,p as We}from"./CSS3DRenderer-CITJV_e9.js";function je(g){return typeof g=="function"||Object.prototype.toString.call(g)==="[object Object]"&&!U(g)}class Oe{constructor(e,i){this.config=e,this.container=document.querySelector("#"+i),this.camera,this.scene,this.renderer,this.controls,this.model,this.fileLoaderMap={glb:new y,fbx:new K(this.loadingManager),gltf:new y,obj:new Q(this.loadingManager),stl:new ee},this.modelAnimation,this.animationMixer,this.animationColock=new te,this.animationFrame,this.rotationAnimationFrame,this.animateClipAction=null,this.loopMap={LoopOnce:ie,LoopRepeat:se,LoopPingPong:ae},this.skeletonHelper,this.gridHelper,this.axesHelper,this.planeGeometry,this.modelMaterialList,this.effectComposer,this.outlinePass,this.renderAnimation,this.raycaster=new ne,this.mouse=new H,this.modelTextureMap,this.glowComposer,this.unrealBloomPass,this.shaderPass,this.glowMaterialList,this.materials={},this.onWindowResizesListener,this.onMouseMoveListener,this.css3dControls=null,this.css3DRenderer=null}init(){return new Promise(async(e,i)=>{this.initRender(),this.initCamera(),this.initScene(),this.initControls();const t=await this.loadModel(this.config.fileInfo);this.createEffectComposer(),this.setSceneBackground(),this.setModelMeaterial(),this.setModelLaterStage(),this.setSceneLight(),this.setModelAnimation(),this.setModelAxleLine(),this.setSceneTagsRender(),this.sceneAnimation(),this.addEvenListMouseLisatener(),e(t)})}initRender(){this.renderer=new oe({antialias:!0,alpha:!0,preserveDrawingBuffer:!0}),this.renderer.setPixelRatio(window.devicePixelRatio);const{clientHeight:e,clientWidth:i}=this.container;this.renderer.setSize(i,e),this.renderer.toneMapping=re,this.renderer.autoClear=!0,this.renderer.outputColorSpace=B,this.renderer.toneMappingExposure=2,this.renderer.shadowMap.enabled=!0,this.renderer.shadowMap.type=le,this.container.appendChild(this.renderer.domElement),this.css3DRenderer=new he,this.css3DRenderer.setSize(i,e),this.css3DRenderer.domElement.style.position="absolute",this.css3DRenderer.domElement.style.pointerEvents="none",this.css3DRenderer.domElement.style.top=0}initCamera(){const{clientHeight:e,clientWidth:i}=this.container;this.camera=new de(45,i/e,.25,2e3);const{camera:t}=this.config;if(!t)return!1;const{x:s,y:o,z:n}=t;this.camera.position.set(s,o,n),this.camera.updateProjectionMatrix()}initScene(){this.scene=new A}addEvenListMouseLisatener(){this.onWindowResizesListener=this.onWindowResize.bind(this),window.addEventListener("resize",this.onWindowResizesListener)}initControls(){this.controls=new W(this.camera,this.renderer.domElement),this.controls.enablePan=!0,this.controls.enabled=!0,this.controls.target.set(0,0,0),this.css3dControls=new W(this.camera,this.css3DRenderer.domElement),this.css3dControls.enablePan=!1,this.css3dControls.enabled=!1,this.css3dControls.enableDamping=!1,this.css3dControls.target.set(0,0,0),this.css3dControls.update()}sceneAnimation(){this.renderAnimation=requestAnimationFrame(()=>this.sceneAnimation());const{stage:e,tags:i}=this.config;e&&e.glow?this.setMeshFlow():(this.effectComposer.render(),this.controls.update()),i&&i.dragTagList.length&&(this.css3DRenderer.render(this.scene,this.camera),this.css3dControls.update())}setMeshFlow(){this.scene.traverse(e=>{e instanceof F&&(this.materials.gridHelper=e.material,e.material=new L({color:"#000"})),e instanceof A&&(this.materials.scene=e.background,this.materials.environment=e.environment,e.background=null,e.environment=null),!this.glowMaterialList.includes(e.name)&&e.isMesh&&(this.materials[e.uuid]=e.material,e.material=new L({color:"#000"}))}),this.glowComposer.render(),this.scene.traverse(e=>{this.materials[e.uuid]&&(e.material=this.materials[e.uuid],delete this.materials[e.uuid]),e instanceof F&&(e.material=this.materials.gridHelper,delete this.materials.gridHelper),e instanceof A&&(e.background=this.materials.scene,e.environment=this.materials.environment,delete this.materials.scene,delete this.materials.environment)}),this.effectComposer.render(),this.controls.update()}createEffectComposer(){const{clientHeight:e,clientWidth:i}=this.container;this.effectComposer=new j(this.renderer);const t=new O(this.scene,this.camera);this.effectComposer.addPass(t),this.outlinePass=new ce(new H(i,e),this.scene,this.camera),this.outlinePass.visibleEdgeColor=new p("#FF8C00"),this.outlinePass.hiddenEdgeColor=new p("#8a90f3"),this.outlinePass.edgeGlow=2,this.outlinePass.edgeThickness=1,this.outlinePass.edgeStrength=4,this.outlinePass.pulsePeriod=100,this.effectComposer.addPass(this.outlinePass);let s=new me;this.effectComposer.addPass(s);let o=new I(pe);const n=this.renderer.getPixelRatio();o.uniforms.resolution.value.set(1/(i*n),1/(e*n)),o.renderToScreen=!0,o.needsSwap=!0,this.effectComposer.addPass(o),this.unrealBloomPass=new ue(new H(i,e),0,0,0);const a={minFilter:M,magFilter:M,format:We,stencilBuffer:!1},r=new ge(i*2,e*2,a);this.glowComposer=new j(this.renderer,r),this.glowComposer.renderToScreen=!1,this.glowComposer.addPass(new O(this.scene,this.camera)),this.glowComposer.addPass(this.unrealBloomPass),this.shaderPass=new I(new fe({uniforms:{baseTexture:{value:null},bloomTexture:{value:this.glowComposer.renderTarget2.texture},tDiffuse:{value:null},glowColor:{value:null}},vertexShader:we,fragmentShader:Le,defines:{}}),"baseTexture"),this.shaderPass.material.uniforms.glowColor.value=new p,this.shaderPass.renderToScreen=!0,this.shaderPass.needsSwap=!0,this.effectComposer.addPass(this.shaderPass)}loadModel({filePath:e,fileType:i,map:t}){return new Promise((s,o)=>{let n;if(["glb","gltf"].includes(i)){const a=new Ce;a.setDecoderPath("draco/gltf/"),a.setDecoderConfig({type:"js"}),a.preload(),n=new y().setDRACOLoader(a)}else n=this.fileLoaderMap[i];n.load(e,a=>{switch(i){case"glb":this.model=a.scene,this.skeletonHelper=new C(a.scene);break;case"fbx":this.model=a,this.skeletonHelper=new C(a);break;case"gltf":this.model=a.scene,this.skeletonHelper=new C(a.scene);break;case"obj":this.model=a,this.skeletonHelper=new C(a);break;case"stl":const r=new L,h=new G(a,r);this.model=h;break}this.getModelMeaterialList(t),this.modelAnimation=a.animations||[],this.setModelPositionSize(),this.skeletonHelper.visible=!1,this.scene.add(this.skeletonHelper),this.glowMaterialList=this.modelMaterialList.map(r=>r.name),this.scene.add(this.model),s(!0)},()=>{},a=>{Y.error("文件错误"),console.log(a),o()})})}onWindowResize(){const{clientHeight:e,clientWidth:i}=this.container;if(this.camera.aspect=i/e,this.camera.updateProjectionMatrix(),this.renderer.setSize(i,e),this.css3DRenderer.setSize(i,e),this.effectComposer){var t=this.effectComposer.passes[3];const s=this.renderer.getPixelRatio();t.uniforms.resolution.value.set(1/(i*s),1/(e*s)),this.effectComposer.setSize(i,e)}this.glowComposer&&this.glowComposer.setSize(i,e)}onClearModelData(){cancelAnimationFrame(this.rotationAnimationFrame),cancelAnimationFrame(this.renderAnimation),cancelAnimationFrame(this.animationFrame),this.config,this.scene.traverse(e=>{e.type==="Mesh"&&(e.geometry.dispose(),e.material.dispose())}),this.scene.clear(),this.renderer.clear(),this.renderer.dispose(),this.camera.clear(),this.gridHelper&&(this.gridHelper.clear(),this.gridHelper.dispose()),this.axesHelper&&(this.axesHelper.clear(),this.axesHelper.dispose()),this.effectComposer&&this.effectComposer.dispose(),this.glowComposer&&this.glowComposer.dispose(),this.container.removeEventListener("mousemove",this.onMouseMoveListener),window.removeEventListener("resize",this.onWindowResizesListener),this.config=null,this.container=null,this.camera=null,this.scene=null,this.renderer=null,this.controls=null,this.model=null,this.fileLoaderMap=null,this.modelAnimation=null,this.animationMixer=null,this.animationColock=null,this.animationFrame=null,this.rotationAnimationFrame=null,this.animateClipAction=null,this.loopMap=null,this.skeletonHelper=null,this.gridHelper=null,this.axesHelper=null,this.planeGeometry=null,this.modelMaterialList=null,this.effectComposer=null,this.outlinePass=null,this.renderAnimation=null,this.raycaster==null,this.mouse=null,this.modelTextureMap=null,this.glowComposer=null,this.unrealBloomPass=null,this.shaderPass=null,this.glowMaterialList=null,this.materials=null,this.css3dControls=null,this.css3DRenderer=null}setModelPositionSize(){this.model.updateMatrixWorld();const e=new be().setFromObject(this.model),i=e.getSize(new N),t=e.getCenter(new N),s=Math.max(i.x,i.y,i.z),n=2.5/(s>1?s:.5);this.model.scale.set(n,n,n),this.model.position.sub(t.multiplyScalar(n)),this.controls.maxDistance=i.length()*10,this.camera.updateProjectionMatrix()}getModelMeaterialList(){this.modelMaterialList=[],this.model.traverse(e=>{if(e.isMesh&&(e.castShadow=!0,e.frustumCulled=!1,e.material)){const i=e.material.clone();e.material=i,this.modelMaterialList.push(e)}})}setSceneBackground(){const{background:e}=this.config;if(!e)return!1;if(e.visible){const{color:i,image:t,viewImg:s,intensity:o,blurriness:n}=e;switch(e.type){case 1:this.scene.background=new p(i);break;case 2:const a=new b().load(t);this.scene.background=a,a.dispose();break;case 3:const r=new b().load(s);r.mapping=Me,this.scene.background=r,this.scene.environment=r,this.scene.backgroundIntensity=o,this.scene.backgroundBlurriness=n,r.dispose();break}}else this.scene.background=new p("#000")}setModelMeaterial(){const{material:e}=this.config;if(!e||!e.meshList)return!1;const i=V.map(t=>t.id);e.meshList.forEach(t=>{const s=this.model.getObjectByProperty("name",t.meshName),{color:o,opacity:n,depthWrite:a,wireframe:r,visible:h,type:d}=t,{map:m}=s.material;if(e.materialType?s.material=new z[d]({map:m}):s.material.map=m,t.meshFrom)if(i.includes(t.meshFrom)){const c=V.find(f=>f.id==t.meshFrom)||{},l=new b().load(c.url);l.wrapS=q,l.wrapT=q,l.flipY=!1,l.colorSpace=B,l.minFilter=M,l.magFilter=M,e.materialType?s.material=new z[d]({map:l}):s.material.map=l,l.dispose()}else{const c=this.model.getObjectByProperty("name",t.meshFrom),{map:l}=c.material;e.materialType?s.material=new z[d]({map:l}):s.material.map=l}s.material.visible=h,s.material.color.set(new p(o)),s.material.wireframe=r,s.material.depthWrite=a,s.material.transparent=!0,s.material.opacity=n})}setModelLaterStage(){const{stage:e}=this.config;if(!e)return!1;const{threshold:i,strength:t,radius:s,toneMappingExposure:o,meshPositonList:n,color:a}=e;e.glow?(this.unrealBloomPass.threshold=i,this.unrealBloomPass.strength=t,this.unrealBloomPass.radius=s,this.renderer.toneMappingExposure=o,this.shaderPass.material.uniforms.glowColor.value=new p(a)):(this.unrealBloomPass.threshold=0,this.unrealBloomPass.strength=0,this.unrealBloomPass.radius=0,this.renderer.toneMappingExposure=o,this.shaderPass.material.uniforms.glowColor.value=new p),n.forEach(r=>{const h=this.model.getObjectByProperty("name",r.name),{rotation:d,scale:m,position:c}=r;h.rotation.set(d.x,d.y,d.z),h.scale.set(m.x,m.y,m.z),h.position.set(c.x,c.y,c.z)})}setSceneLight(){const{light:e}=this.config;if(!e)return!1;if(e.ambientLight){const t=new xe(e.ambientLightColor,e.ambientLightIntensity);t.visible=e.ambientLight,this.scene.add(t)}if(e.directionalLight){const t=new Se(e.directionalLightColor,e.directionalLightIntensity),{x:s,y:o,z:n}=R(e.directionalHorizontal,e.directionalVertical,e.directionalSistance);t.position.set(s,o,n),t.castShadow=e.directionaShadow,t.visible=e.directionalLight,this.scene.add(t);const a=new Pe(t,.5);a.visible=e.directionalLightHelper,this.scene.add(a)}if(e.pointLight){const t=new ye(e.pointLightColor,e.pointLightIntensity,100);t.visible=e.pointLight;const{x:s,y:o,z:n}=R(e.pointHorizontal,e.pointVertical,e.pointSistance);t.position.set(s,o,n),this.scene.add(t);const a=new He(t,.5);a.visible=e.pointLightHelper,this.scene.add(a)}if(e.spotLight){const t=new Ae(e.spotLightColor,900);t.visible=e.spotLight;const s=new b().load(Fe("image/model-bg-1.jpg"));s.dispose(),t.map=s,t.decay=2,t.shadow.mapSize.width=1920,t.shadow.mapSize.height=1080,t.shadow.camera.near=1,t.shadow.camera.far=10,t.intensity=e.spotLightIntensity,t.angle=e.spotAngle,t.penumbra=e.spotPenumbra,t.shadow.focus=e.spotFocus,t.castShadow=e.spotCastShadow,t.distance=e.spotDistance;const{x:o,y:n,z:a}=R(e.spotHorizontal,e.spotVertical,e.spotSistance);t.position.set(o,n,a),this.scene.add(t);const r=new ze(t);r.visible=e.spotLightHelper&&e.spotLight,this.scene.add(r)}if(e.planeGeometry){const t=new Re(e.planeWidth,e.planeHeight);var i=new L({color:e.planeColor});const s=new G(t,i);s.rotation.x=-Math.PI/2,s.position.set(0,-1.2,0),s.visible=e.planeGeometry,s.material.side=ve,s.geometry.verticesNeedUpdate=!0,s.receiveShadow=!0,this.scene.add(s)}}setModelAnimation(){const{animation:e}=this.config;if(!e)return!1;if(this.modelAnimation.length&&e&&e.visible){this.animationMixer=new Ee(this.model);const{animationName:i,timeScale:t,weight:s,loop:o}=e,n=ke.findByName(this.modelAnimation,i);n&&(this.animateClipAction=this.animationMixer.clipAction(n),this.animateClipAction.setEffectiveTimeScale(t),this.animateClipAction.setEffectiveWeight(s),this.animateClipAction.setLoop(this.loopMap[o]),this.animateClipAction.play()),this.animationFrameFun()}if(e.rotationVisible){const{rotationType:i,rotationSpeed:t}=e;this.rotationAnimationFun(i,t)}}animationFrameFun(){this.animationFrame=requestAnimationFrame(()=>this.animationFrameFun()),this.animationMixer&&this.animationMixer.update(this.animationColock.getDelta())}rotationAnimationFun(e,i){this.rotationAnimationFrame=requestAnimationFrame(()=>this.rotationAnimationFun(e,i)),this.model.rotation[e]+=i/50}setModelAxleLine(){const{attribute:e}=this.config;if(!e)return!1;const{axesHelper:i,axesSize:t,color:s,divisions:o,gridHelper:n,positionX:a,positionY:r,positionZ:h,size:d,skeletonHelper:m,visible:c,x:l,y:f,z:x,rotationX:E,rotationY:S,rotationZ:w}=e;if(!c)return!1;this.gridHelper=new F(d,o,s,s),this.gridHelper.position.set(l,f,x),this.gridHelper.visible=n,this.gridHelper.material.linewidth=.1,this.scene.add(this.gridHelper),this.axesHelper=new De(t),this.axesHelper.visible=i,this.axesHelper.position.set(0,-.5,0),this.scene.add(this.axesHelper),this.model.position.set(a,r,h),this.model.rotation.set(E,S,w),this.renderer.shadowMap.enabled=!0,this.skeletonHelper.visible=m}setSceneTagsRender(){const{tags:e}=this.config;e&&e.dragTagList.length&&(this.container.appendChild(this.css3DRenderer.domElement),e.dragTagList.forEach(i=>{let t=document.createElement("div");const{backgroundColor:s,color:o,fontSize:n,height:a,iconColor:r,iconName:h,iconSize:d,innerText:m,positionX:c,positionY:l,positionZ:f,width:x}=i,S=Z({render(){let P;return u("div",null,[u("div",{className:"element-tag",style:{width:x+"px",height:a+"px",fontSize:n+"px",color:o,backgroundColor:s,boxShadow:`0px 0px 4px ${s}`}},[u("span",{className:"tag-txt"},[m])]),u("div",{className:"tag-icon"},[u($,null,je(P=v(J[h]))?P:{default:()=>[P]})])])}}).mount(document.createElement("div"));t.appendChild(S.$el);let w=new Te(t);w.position.set(c,l,f),w.scale.set(.01,.01,.01);const k=t.querySelector(".tag-icon");k.style.fontSize=d+"px",k.style.color=r,this.scene.add(w)}))}}function Ne(g){const e="answer"+_(5,10);let i=null;return X({data(){return{loading:!1}},props:["width","height"],watch:{$props:{handler(t){i&&Be(i.onWindowResize(),200)},immediate:!1,deep:!0}},render(){return this.width&&this.height?v(D(u("div",{style:{width:this.width-10+"px",height:this.height-10+"px",pointerEvents:"none"},id:e},null),[[T("zLoading"),this.loading]])):v(D(u("div",{style:{width:"100%",height:"100%"},id:e},null),[[T("zLoading"),this.loading]]))},async mounted(){this.loading=!0,i=new Oe(g,e),await i.init()&&(this.loading=!1)},beforeUnmount(){i.onClearModelData()}})}export{Ne as c};
